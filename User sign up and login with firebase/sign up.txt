import React, { useState } from 'react';
import { Text, View, TextInput, ImageBackground, TouchableOpacity, ToastAndroid } from 'react-native';
import { useNavigation } from '@react-navigation/native';

import images from './../constants/images';
import { AuthContext } from './Context';
import styles from './../constants/styles';

export default function CreateAccount() {

  const [fullName, setFullName] = useState('');
  const [phoneNumber, setPhoneNumber] = useState('');
  const [emailAddress, setEmailAddress] = useState('');
  const [password1, setPassword1] = useState('');
  const [password2, setPassword2] = useState('');

  const context = React.useContext(AuthContext);
  const navigation = useNavigation();

  function validateEmail(email) {
    const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }

  return (
    <View style={styles.container}>

      <ImageBackground source={images.backgroundImage} style={styles.image}>
        <Text style={styles.heading1}>Sign Up</Text>
        <Text style={styles.info}>Create your account</Text>
        <View style={styles.inputView} >
          <TextInput
            style={styles.inputText}
            placeholder="Full name"
            placeholderTextColor="#4C4C4C"
            value={fullName}
            onChangeText={setFullName}
          />
        </View>
        <View style={styles.inputView} >
          <TextInput
            style={styles.inputText}
            placeholder="Phone number..."
            placeholderTextColor="#4C4C4C"
            keyboardType={'phone-pad'}
            value={phoneNumber}
            onChangeText={setPhoneNumber}
          />
        </View>
        <View style={styles.inputView} >
          <TextInput
            style={styles.inputText}
            placeholder="Email..."
            placeholderTextColor="#4C4C4C"
            keyboardType={'email-address'}
            value={emailAddress}
            onChangeText={setEmailAddress}
          />
        </View>
        <View style={styles.inputView} >
          <TextInput
            secureTextEntry
            style={styles.inputText}
            placeholder="Password..."
            placeholderTextColor="#4C4C4C"
            secureTextEntry={true}
            value={password1}
            onChangeText={setPassword1}
          />
        </View>
        <View style={styles.inputView} >
          <TextInput
            secureTextEntry
            style={styles.inputText}
            placeholder="Confirm Password..."
            placeholderTextColor="#4C4C4C"
            secureTextEntry={true}
            value={password2}
            onChangeText={setPassword2}
          />
        </View>

        <TouchableOpacity style={styles.loginBtn} onPress={() => {

          if (phoneNumber && emailAddress && password1 && password2) {
            if (password1 != password2) {
              ToastAndroid.show("Confirm password do not match!", ToastAndroid.SHORT);
            } else if (!validateEmail(emailAddress)) {
              ToastAndroid.show("Invalid email address!", ToastAndroid.SHORT);
            } else {
              console.log("Sending OTP");
              ToastAndroid.show("Sending OTP", ToastAndroid.SHORT);

              try {
                context.sendOtp(phoneNumber, () => {
                  navigation.navigate('Verification', {number: phoneNumber,email: emailAddress,password: password1,fullName: fullName, signUp: true })
                });
              } catch (error) {
                ToastAndroid.show(error.message, ToastAndroid.SHORT);
              }
            }
          } else {
            ToastAndroid.show("Please fill all fields!", ToastAndroid.SHORT);
          }
        }}>
          <Text style={styles.loginText}>SIGN UP</Text>
        </TouchableOpacity>
        <TouchableOpacity onPress={() => navigation.push("Login")}>
          <Text style={styles.loginText}>Already have an account? Login</Text>
        </TouchableOpacity>

      </ImageBackground>

    </View>
  );
}
