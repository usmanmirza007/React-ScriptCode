import React, { useState, useEffect } from 'react';
import { StyleSheet, Text, View, StatusBar, Image, ImageBackground, TextInput, TouchableOpacity, ToastAndroid } from 'react-native';
import { ScrollView } from 'react-native-gesture-handler';
import { useNavigation } from '@react-navigation/native';

import { AuthContext } from "./Context";
import auth from '@react-native-firebase/auth';

import OTPRow from '../components/OTPRow'
import images from './../constants/images'
const image = { uri: "http://filmstack.in/media/media/filmstack_bg_org.png" };

const Verification = ({ route }) => {

  const context = React.useContext(AuthContext);
  const navigation = useNavigation()

  const [otp, setOtp] = useState('');
  const [otpGenerationTime, setOtpGenerationTime] = useState(null);
  const [secondCount, setSecondCount] = useState(30);
  const email = route.params.email
  const number = route.params.number
  const signUp = route.params.signUp
  const password = route.params.password
  const fullName = route.params.fullName

  // console.log(email);
  const mod = (secondCount) => {
    const sec = secondCount % 60;
    const res = secondCount - sec;
    const mint = res / 60;
    return {
      mints: mint,
      secs: sec,
    };
  }

  var time = mod(secondCount);
  useEffect(() => {
    if (secondCount == 0) {
      return;
    }
    const timeout = setTimeout(() => {
      setSecondCount(secondCount - 1);
    }, 1000);

    return () => {
      clearTimeout(timeout);
    };
  }, [secondCount]);

  return (
    <View style={styles.container}>
      <StatusBar
        barStyle="light-content"
        backgroundColor="#000"
      />
      <ImageBackground source={image} style={styles.image}>
        <ScrollView>
          <View style={{ flexDirection: 'row', marginTop: 45, marginLeft: 20, alignItems: 'center' }}>
            <Image
              style={{ width: 20, height: 20, tintColor: '#fff', }}
              source={require('./../assets/images/arrow.png')}
            />
            <Text style={{ color: '#fff', marginLeft: 15, fontSize: 18, fontWeight: '700' }}>Verify Mobile Number</Text>
          </View>
          <Image
            style={{ alignSelf: 'center', marginTop: 20, width: 200, height: 200 }}
            source={images.lock}
          />
          <Text style={{ color: '#747675', fontSize: 12, marginTop: 50, alignSelf: 'center', fontWeight: '500' }}>Enter 4 digit verification code sent to your number</Text>
          <Text style={{ color: '#fff', fontSize: 15, marginTop: 10, alignSelf: 'center', fontWeight: '700' }}>Enter code</Text>
          <OTPRow updateOtp={setOtp} />
          <Text
            style={{ alignSelf: 'center', marginBottom: 22, marginTop: 15, fontSize: 17, color: '#fff' }}>
            {time.mints + ':' + time.secs}
          </Text>
          <TouchableOpacity onPress={async () => {
            if (otp && otp.length == 6) {
              try {
                await context.confirmCode(otp);
                if (signUp) {
                  console.log('data');
                  await context.setEmailPassword(email, password);
                  await context.setProfileInfo(fullName);
                } else {

                  const user = auth().currentUser
                  if (email && password) {
                    // await context.loginWithEmailPassword(email, password);
                    // navigation.navigate('HomeScreen')
                  } else {
                    ToastAndroid.show("Please sign up first", ToastAndroid.SHORT);
                  }
                }
              } catch (error) {
                console.log('erroe', error);
                ToastAndroid.show("Invalid Code", ToastAndroid.SHORT);
              }
            }
          }} style={styles.loginBtn}>
            <Text style={styles.loginText}>Continue</Text>
          </TouchableOpacity>
          <View style={{ flexDirection: 'row', alignSelf: 'center', marginTop: 15, marginBottom: 10 }}>
            <Text
              style={{
                fontSize: 14,
                color: '#747675'
              }}>
              Didn't receive the code?
            </Text>
            <TouchableOpacity
              disabled={secondCount != 0}
              onPress={() => {
                // signInWithPhoneNumber(phoneNumber);
              }}>
              <Text
                style={{
                  marginLeft: 5,
                  fontSize: 14,
                  color: secondCount != 0 ? '#747675' : '#fff',
                }}>
                Resend
              </Text>
            </TouchableOpacity>
          </View>
        </ScrollView>
      </ImageBackground>

    </View>
  )
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#000',
  },
  loginBtn: {
    width: "80%",
    backgroundColor: "#2A2A2A",
    borderRadius: 25,
    height: 50,
    alignItems: "center",
    justifyContent: "center",
    alignSelf: 'center',
    marginTop: 10,
  },
  loginText: {
    color: '#fff',
    marginLeft: 15,
    fontSize: 18,
    fontWeight: '700'
  },
  image: {
    resizeMode: "cover",
    flex: 1

  },
});

export default Verification